name: Build Webview
on:
  workflow_dispatch:
    inputs:
      os:
        description: 'Which OS to build webview with'
        required: true
        default: 'ubuntu-latest'
        type: choice
        options:
        - Linux
        - Windows
        - MacOS
jobs:
  build_linux:
    if: ${{ inputs.os == 'Linux' }}
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./scripts/webview
    steps:
    - name: Check out the repository to the runner
      uses: actions/checkout@v4

    - name: Install os dependencies
      run: ./prepare.ubuntu.sh
        
    - name: Build webview for ${{ inputs.os }}
      run: ./build.linux.sh

    - name: Build webview for ${{ inputs.os }} arm64
      uses: |
        actions/checkout@v4
        uraimo/run-on-arch-action@v2
          with:
            arch: armv7
            distro: ubuntu22.04
            dockerRunArgs: |
              --volume "${PWD}/bin/webview:/artifacts"
            shell: /bin/sh
            install: |
              apt-get update -q -y
              apt-get install -q -y git

        - name: Install os dependencies
          run: ./prepare.ubuntu.sh
        
        - name: Build webview for ${{ inputs.os }}
          run: ./build.linux.sh

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: libwebview_linux
        path: bin/webview/**/*.so
        overwrite: true

  build_windows:
    if: ${{ inputs.os == 'Windows' }}
    runs-on: windows-latest
    defaults:
      run:
        working-directory: ./scripts/webview
    steps:
    - name: Check out the repository to the runner
      uses: actions/checkout@v4

    - name: Install os dependencies
      run: ./prepare.windows.bat
        
    - name: Build webview for ${{ inputs.os }}
      run: ./build.windows.bat

    - uses: actions/upload-artifact@v4
      with:
        name: libwebview_windows
        path: bin/webview/**/*.dll
        overwrite: true

  build_mac:
    if: ${{ inputs.os == 'MacOs' }}
    runs-on: macos-latest
    defaults:
      run:
        working-directory: ./scripts/webview
    steps:
    - name: Check out the repository to the runner
      uses: actions/checkout@v4

    - name: Install os dependencies
      run: ./prepare.macos.sh
        
    - name: Build webview for ${{ inputs.os }}
      run: ./build.macos.sh

    - uses: actions/upload-artifact@v4
      with:
        name: libwebview_mac
        path: bin/webview/**/*.dylib
        overwrite: true
